study("Log Bollinger Bands %BB Oscillator [Krypt]", shorttitle="Log BB %B")

length=input(187, title="Length")
lengthMA=input(187, title="MA Length")
stdDev = input(3.1416, title="StdDev")
src=input(close, type=source, title="Source")
showMA = input(false, title="Show Moving Average")

price = log(src)
xsd = stdev(price, length)
num = price + stdDev * xsd - sma(price, length)
bbWidth = 2 * stdDev * xsd
zScoreOf_lnOf_price = (num / bbWidth) - 0.5
ema = ema(zScoreOf_lnOf_price, lengthMA)
// ma = (ema(num, lengthMA) / ema(bbWidth, lengthMA) ) - 0.5
ma = sma(zScoreOf_lnOf_price, lengthMA)


zero=hline(0, color=#c0c0c0, linestyle=solid)
ob=hline(0.5, color=#c0c0c0)
os=hline(-0.5, color=#c0c0c0)
fill(ob, os, color=#138484)

myMetric = ema( ((zScoreOf_lnOf_price + ema) * (1+abs(ema-ma)) / (1+xsd)) + zScoreOf_lnOf_price, lengthMA)

plot(zScoreOf_lnOf_price, color=#fd9418, linewidth=1, transp=0, title="Bollinger Bands %B")
plot(ma, title="Moving Average")
// plot(showMA ? (ma-0.5)*zScoreOf_lnOf_price : na, color=gray, title="Weighted Moving Average")
// plot(showMA ? (ma-0.5)*zScoreOf_lnOf_price/log(xsd) : na, color=white, title="Weighted Moving Average")
// plot(showMA ? (ma)*zScoreOf_lnOf_price/xsd : na, color=blue, title="Weighted Moving Average")
plot(ema, color=#00ffff, title="EMA")
plot(ema(ema-ma, lengthMA)/xsd, color=#ff00ff, title="EMA(EMA-MA)")
plot(myMetric, color=#aaff00, title="MA(EMA-MA)")
plot(highest(zScoreOf_lnOf_price, lengthMA), color=#3300ff, title="Max")
